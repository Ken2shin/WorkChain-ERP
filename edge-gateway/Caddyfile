:443 {
  # TLS Configuration - Modern & Secure
  tls /etc/certs/workchain.crt /etc/certs/workchain.key {
    protocols tls1.2 tls1.3
    ciphers TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
    curves x25519 secp384r1
    alpn h2 http/1.1
  }

  # Security Headers - OWASP Compliance
  header / {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:"
    -Server
    -X-Powered-By
  }

  # DDoS Mitigation at Edge
  request_header_regexp {
    filter User-Agent "^$|bot|crawler|scraper|spider|curl|wget" {
      rate_limit 10/m
    }
  }

  # IP Filtering & Geolocation (placeholder for external service)
  # This would integrate with MaxMind GeoIP or similar
  @blocked_countries {
    header GeoIP-Country ~^(KP|IR|SY)$
  }
  handle @blocked_countries {
    abort 403
  }

  # Request Normalization
  @large_payload {
    header Content-Length -1
    header -Content-Length
  }
  handle @large_payload {
    abort 413
  }

  # Reverse Proxy to Laravel Backend
  reverse_proxy localhost:8000 {
    # Connection pooling
    transport http {
      keepalive_idle_timeout 60s
      read_timeout 30s
      write_timeout 30s
    }

    # Header injection for security context
    header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
    header_up X-Forwarded-Proto https
    header_up X-Real-IP {http.request.remote.host}
    header_up X-Request-ID {http.request.header.X-Request-ID}
  }
}

# Health Check Endpoint (Internal only)
:9090 {
  @health path /health
  handle @health {
    header Content-Type application/json
    respond `{"status":"healthy"}` 200
  }
  handle {
    abort 404
  }
}
