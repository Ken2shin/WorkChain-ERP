version: "3.8"

services:
  # =========================
  # PostgreSQL
  # =========================
  postgres:
    image: postgres:16-alpine
    container_name: workchain_postgres
    environment:
      POSTGRES_DB: workchain_erp
      POSTGRES_USER: workchain_user
      POSTGRES_PASSWORD: secure_password_change_me
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - workchain_network

  # =========================
  # Laravel Backend
  # =========================
  laravel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: workchain_app
    env_file:
      - .env
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: workchain_erp
      DB_USERNAME: workchain_user
      DB_PASSWORD: secure_password_change_me
      APP_ENV: production
      APP_DEBUG: "false"
    depends_on:
      - postgres
      - crypto-service
      - anomaly-detector
    networks:
      - workchain_network

  # =========================
  # Astro Frontend
  # =========================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: workchain_frontend
    env_file:
      - .env
    environment:
      PUBLIC_API_BASE: https://api.workchain.com
    depends_on:
      - laravel
    networks:
      - workchain_network

  # =========================
  # Go Crypto Service
  # =========================
  crypto-service:
    build:
      context: ./services/go/crypto-service
      dockerfile: Dockerfile
    container_name: workchain_crypto
    env_file:
      - .env
    environment:
      PORT: 3000
    networks:
      - workchain_network

  # =========================
  # Rust Anomaly Detector
  # =========================
  anomaly-detector:
    build:
      context: ./services/rust/anomaly-detector
      dockerfile: Dockerfile
    container_name: workchain_anomaly
    env_file:
      - .env
    environment:
      PORT: 3001
    networks:
      - workchain_network

  # =========================
  # Redis
  # =========================
  redis:
    image: redis:7-alpine
    container_name: workchain_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - workchain_network

  # =========================
  # Caddy Gateway (ÃšNICO expuesto)
  # =========================
  gateway:
    image: caddy:2.8
    container_name: workchain_gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./edge-gateway/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - laravel
    networks:
      - workchain_network

volumes:
  postgres_data:
  caddy_data:
  caddy_config:

networks:
  workchain_network:
    driver: bridge
