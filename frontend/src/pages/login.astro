---
import Layout from '../layouts/Layout.astro';

const apiBaseUrl = import.meta.env.PUBLIC_API_BASE ?? 'http://localhost:8000/api';
const year = new Date().getFullYear();
---

<Layout title="Login - WorkChain ERP">
  <div class="relative min-h-screen flex items-center justify-center px-4
              bg-gradient-to-br from-slate-100 via-white to-slate-200 overflow-hidden">

    <!-- blobs decorativos -->
    <div class="absolute -top-32 -left-32 w-96 h-96 bg-blue-400/30 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-32 -right-32 w-96 h-96 bg-indigo-400/30 rounded-full blur-3xl"></div>

    <!-- card -->
    <div
      x-data="loginData()"
      class="relative w-full max-w-md rounded-3xl
             bg-white/70 backdrop-blur-xl
             border border-white/40
             shadow-xl shadow-black/10
             p-8 sm:p-10"
    >

      <!-- header -->
      <div class="text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">
          WorkChain ERP
        </h1>
        <p class="mt-2 text-sm text-slate-600">
          Inicia sesión para continuar
        </p>
      </div>

      <!-- form -->
      <form class="mt-8 space-y-5" @submit.prevent="submitLogin">

        <!-- email -->
        <div>
          <label class="sr-only" for="email">Correo</label>
          <input
            id="email"
            type="email"
            required
            x-model="email"
            placeholder="correo@empresa.com"
            class="w-full px-4 py-3 rounded-xl
                   bg-white border border-slate-300
                   text-slate-900 placeholder-slate-400
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   transition"
          />
        </div>

        <!-- password -->
        <div>
          <label class="sr-only" for="password">Contraseña</label>
          <input
            id="password"
            type="password"
            required
            x-model="password"
            placeholder="••••••••"
            class="w-full px-4 py-3 rounded-xl
                   bg-white border border-slate-300
                   text-slate-900 placeholder-slate-400
                   focus:outline-none focus:ring-2 focus:ring-indigo-500
                   transition"
          />
        </div>

        <!-- button -->
        <button
          type="submit"
          :disabled="loading"
          class="w-full py-3 rounded-xl font-semibold text-white
                 bg-gradient-to-r from-blue-600 to-indigo-600
                 hover:from-blue-700 hover:to-indigo-700
                 active:scale-95
                 shadow-lg shadow-blue-500/30
                 transition
                 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          <span x-show="!loading">Ingresar</span>
          <span x-show="loading">Validando…</span>
        </button>
      </form>

      <!-- footer -->
      <div class="mt-6 text-center text-xs text-slate-500">
        © {year} WorkChain · Secure ERP
      </div>

    </div>
  </div>

  <!-- alpine -->
  <script define:vars={{ apiBase: apiBaseUrl }}>
    document.addEventListener('alpine:init', () => {
      Alpine.data('loginData', () => ({
        email: '',
        password: '',
        loading: false,

        async submitLogin() {
          if (this.loading) return;
          this.loading = true;

          try {
            const response = await fetch(`${apiBase}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                email: this.email,
                password: this.password
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data?.message ?? 'Error de autenticación');
            }

            localStorage.setItem('auth_token', data.token);
            window.location.href = '/dashboard';

          } catch (err) {
            alert(err.message);
          } finally {
            this.loading = false;
          }
        }
      }));
    });
  </script>
</Layout>
